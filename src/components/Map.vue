<template>
  <div class="map" id="map">
  </div>
</template>

<script>
import L from 'leaflet'
export default {
  name: 'Map',
  data() {
    return {
      map: null,
      mapMinZoom: 12,
      mapMaxZoom: 20,
      tileLayer: null,
      backgroundLayer: {
        id: 0,
        name: "Kota Bandung",
        active: true,
        coords: [
            [-6.839250, 107.596872],
            [-6.843597, 107.596528],
            [-6.843512, 107.596099],
            [-6.846154, 107.594554],
            [-6.845642, 107.593953],
            [-6.846835, 107.593266],
            [-6.846409, 107.592751],
            [-6.849647, 107.589577],
            [-6.853482, 107.590349],
            [-6.853482, 107.588632],
            [-6.857402, 107.589233],
            [-6.859618, 107.586229],
            [-6.859533, 107.583826],
            [-6.859788, 107.583998],
            [-6.867372, 107.576959],
            [-6.867543, 107.575586],
            [-6.868821, 107.577045],
            [-6.875980, 107.573783],
            [-6.877172, 107.573956],
            [-6.878280, 107.572582],
            [-6.883989, 107.571638],
            [-6.886290, 107.572840],
            [-6.890721, 107.576359],
            [-6.887994, 107.562797],
            [-6.888164, 107.558334],
            [-6.889016, 107.556274],
            [-6.910319, 107.569063],
            [-6.912108, 107.565458],
            [-6.916965, 107.564686],
            [-6.919777, 107.564943],
            [-6.924548, 107.565201],
            [-6.928468, 107.562884],
            [-6.929575, 107.565287],
            [-6.932899, 107.564000],
            [-6.930598, 107.558935],
            [-6.927616, 107.560223],
            [-6.926082, 107.557991],
            [-6.929661, 107.557562],
            [-6.926082, 107.550095],
            [-6.930939, 107.547777],
            [-6.936476, 107.551726],
            [-6.935284, 107.551983],
            [-6.935795, 107.553099],
            [-6.937115, 107.552670],
            [-6.937541, 107.556875],
            [-6.940268, 107.555760],
            [-6.940524, 107.558163],
            [-6.949981, 107.561768],
            [-6.954327, 107.568291],
            [-6.952708, 107.568119],
            [-6.952708, 107.569750],
            [-6.954582, 107.571038],
            [-6.955605, 107.570780],
            [-6.954412, 107.572240],
            [-6.954753, 107.574042],
            [-6.953645, 107.574042],
            [-6.953645, 107.575587],
            [-6.952126, 107.576047],
            [-6.952367, 107.577443],
            [-6.954717, 107.577200],
            [-6.956524, 107.575440],
            [-6.958392, 107.575865],
            [-6.961946, 107.583027],
            [-6.962549, 107.585515],
            [-6.958211, 107.586001],
            [-6.958392, 107.586790],
            [-6.957307, 107.587032],
            [-6.956825, 107.585515],
            [-6.955861, 107.585758],
            [-6.956524, 107.587700],
            [-6.955199, 107.588307],
            [-6.955801, 107.590431],
            [-6.956885, 107.590674],
            [-6.958392, 107.589339],
            [-6.957608, 107.588125],
            [-6.960320, 107.589278],
            [-6.960982, 107.589035],
            [-6.961524, 107.589824],
            [-6.960681, 107.590067],
            [-6.962488, 107.591281],
            [-6.960801, 107.616532],
            [-6.957125, 107.614467],
            [-6.955920, 107.615256],
            [-6.956161, 107.616288],
            [-6.954113, 107.616045],
            [-6.953751, 107.618048],
            [-6.954354, 107.617866],
            [-6.954113, 107.619505],
            [-6.954715, 107.619445],
            [-6.954655, 107.620416],
            [-6.956342, 107.621327],
            [-6.956101, 107.622298],
            [-6.959113, 107.622420],
            [-6.959113, 107.621691],
            [-6.962728, 107.622056],
            [-6.964597, 107.628241],
            [-6.965982, 107.640441],
            [-6.963271, 107.640623],
            [-6.963814, 107.641958],
            [-6.965139, 107.641594],
            [-6.965802, 107.642626],
            [-6.965621, 107.643658],
            [-6.963753, 107.643900],
            [-6.964356, 107.645357],
            [-6.961705, 107.646207],
            [-6.961946, 107.647117],
            [-6.963813, 107.646753],
            [-6.964958, 107.650941],
            [-6.966464, 107.660470],
            [-6.965927, 107.663907],
            [-6.964780, 107.664556],
            [-6.963706, 107.662030],
            [-6.963204, 107.662391],
            [-6.963204, 107.663257],
            [-6.960768, 107.663618],
            [-6.961556, 107.666216],
            [-6.962416, 107.665783],
            [-6.962559, 107.666794],
            [-6.965210, 107.666505],
            [-6.965783, 107.666072],
            [-6.965712, 107.664989],
            [-6.967575, 107.665061],
            [-6.967718, 107.667155],
            [-6.965855, 107.667227],
            [-6.965998, 107.669031],
            [-6.963276, 107.670402],
            [-6.962918, 107.669536],
            [-6.961771, 107.669753],
            [-6.962273, 107.671990],
            [-6.965569, 107.671413],
            [-6.965640, 107.670114],
            [-6.966428, 107.670836],
            [-6.966070, 107.674950],
            [-6.964350, 107.674805],
            [-6.964279, 107.680146],
            [-6.965783, 107.680219],
            [-6.966714, 107.689313],
            [-6.965640, 107.692634],
            [-6.963490, 107.690829],
            [-6.963848, 107.693067],
            [-6.961484, 107.692633],
            [-6.962487, 107.687220],
            [-6.960696, 107.687148],
            [-6.960338, 107.689024],
            [-6.956899, 107.687797],
            [-6.956684, 107.686714],
            [-6.951597, 107.687652],
            [-6.950666, 107.686642],
            [-6.948875, 107.687580],
            [-6.949806, 107.692633],
            [-6.948158, 107.692705],
            [-6.947227, 107.690395],
            [-6.943573, 107.690756],
            [-6.942785, 107.691477],
            [-6.943143, 107.693354],
            [-6.942068, 107.693426],
            [-6.943501, 107.697252],
            [-6.939918, 107.697685],
            [-6.940778, 107.699922],
            [-6.937267, 107.701799],
            [-6.937553, 107.703026],
            [-6.940348, 107.702160],
            [-6.941780, 107.706924],
            [-6.945721, 107.705336],
            [-6.945649, 107.703965],
            [-6.944861, 107.704181],
            [-6.944575, 107.702738],
            [-6.945649, 107.702738],
            [-6.949446, 107.713349],
            [-6.947440, 107.713133],
            [-6.945791, 107.715876],
            [-6.941994, 107.717464],
            [-6.941564, 107.716308],
            [-6.937049, 107.721073],
            [-6.934326, 107.721506],
            [-6.933681, 107.722733],
            [-6.930036, 107.724013],
            [-6.927309, 107.726159],
            [-6.926457, 107.725386],
            [-6.924667, 107.727017],
            [-6.924156, 107.725901],
            [-6.919725, 107.727102],
            [-6.919044, 107.725557],
            [-6.916317, 107.727188],
            [-6.916998, 107.728647],
            [-6.912993, 107.729763],
            [-6.908476, 107.734312],
            [-6.909414, 107.736630],
            [-6.901744, 107.738689],
            [-6.901148, 107.737831],
            [-6.899529, 107.738088],
            [-6.900892, 107.736457],
            [-6.899444, 107.736114],
            [-6.899359, 107.733968],
            [-6.898166, 107.734397],
            [-6.895695, 107.728216],
            [-6.897741, 107.727973],
            [-6.897229, 107.727014],
            [-6.901661, 107.725469],
            [-6.899701, 107.723495],
            [-6.901150, 107.722122],
            [-6.902768, 107.723924],
            [-6.903621, 107.722980],
            [-6.901917, 107.721263],
            [-6.903706, 107.720148],
            [-6.905069, 107.722465],
            [-6.906177, 107.720749],
            [-6.904984, 107.719118],
            [-6.906007, 107.717229],
            [-6.904559, 107.716027],
            [-6.903621, 107.715770],
            [-6.902514, 107.715856],
            [-6.904900, 107.713624],
            [-6.903877, 107.709246],
            [-6.904730, 107.709676],
            [-6.904048, 107.708045],
            [-6.900725, 107.711650],
            [-6.898679, 107.711907],
            [-6.898168, 107.713194],
            [-6.897146, 107.713538],
            [-6.897061, 107.711649],
            [-6.898935, 107.711134],
            [-6.897913, 107.709589],
            [-6.891266, 107.710877],
            [-6.890840, 107.709160],
            [-6.893823, 107.709589],
            [-6.893567, 107.708645],
            [-6.895186, 107.709160],
            [-6.895783, 107.707959],
            [-6.895442, 107.706671],
            [-6.893056, 107.707014],
            [-6.892870, 107.705469],
            [-6.891660, 107.705414],
            [-6.891362, 107.704696],
            [-6.893655, 107.704045],
            [-6.895662, 107.705055],
            [-6.898528, 107.704478],
            [-6.897740, 107.701735],
            [-6.901537, 107.700580],
            [-6.903185, 107.704406],
            [-6.907627, 107.703901],
            [-6.907198, 107.702457],
            [-6.908272, 107.702168],
            [-6.907484, 107.700581],
            [-6.908344, 107.700003],
            [-6.905478, 107.692858],
            [-6.904332, 107.693219],
            [-6.904475, 107.694879],
            [-6.902899, 107.695167],
            [-6.901466, 107.693940],
            [-6.901322, 107.692208],
            [-6.899101, 107.689682],
            [-6.898383, 107.689861],
            [-6.898035, 107.688809],
            [-6.896991, 107.689089],
            [-6.895668, 107.684531],
            [-6.892953, 107.684251],
            [-6.892466, 107.682428],
            [-6.891561, 107.682638],
            [-6.891074, 107.680605],
            [-6.890169, 107.681306],
            [-6.889333, 107.681025],
            [-6.889682, 107.679623],
            [-6.890865, 107.679553],
            [-6.891213, 107.678361],
            [-6.892675, 107.678151],
            [-6.891979, 107.672120],
            [-6.891213, 107.672120],
            [-6.891004, 107.667843],
            [-6.885783, 107.670157],
            [-6.885296, 107.669456],
            [-6.883973, 107.670157],
            [-6.890169, 107.665389],
            [-6.889681, 107.664197],
            [-6.885365, 107.665810],
            [-6.883486, 107.663496],
            [-6.894276, 107.656554],
            [-6.894763, 107.654380],
            [-6.893231, 107.649051],
            [-6.892117, 107.649261],
            [-6.891421, 107.647999],
            [-6.891838, 107.646526],
            [-6.891142, 107.645544],
            [-6.888706, 107.647508],
            [-6.888497, 107.645685],
            [-6.893370, 107.643931],
            [-6.892882, 107.643300],
            [-6.893927, 107.642248],
            [-6.893230, 107.641758],
            [-6.892745, 107.642180],
            [-6.887496, 107.637593],
            [-6.886852, 107.637947],
            [-6.886033, 107.636414],
            [-6.888374, 107.635470],
            [-6.888140, 107.633937],
            [-6.889721, 107.633760],
            [-6.889370, 107.632404],
            [-6.887965, 107.632463],
            [-6.887789, 107.633171],
            [-6.884634, 107.634052],
            [-6.882525, 107.631745],
            [-6.882706, 107.630531],
            [-6.881983, 107.630107],
            [-6.881862, 107.628893],
            [-6.879512, 107.628893],
            [-6.878488, 107.630167],
            [-6.877705, 107.630471],
            [-6.877102, 107.629196],
            [-6.875415, 107.629135],
            [-6.875596, 107.629985],
            [-6.873969, 107.630713],
            [-6.873849, 107.629621],
            [-6.872643, 107.629560],
            [-6.872282, 107.630895],
            [-6.871288, 107.630268],
            [-6.871186, 107.627206],
            [-6.866981, 107.626644],
            [-6.866482, 107.625319],
            [-6.863831, 107.626411],
            [-6.863168, 107.624894],
            [-6.864554, 107.623437],
            [-6.862385, 107.623802],
            [-6.860939, 107.625380],
            [-6.859794, 107.624894],
            [-6.858408, 107.625076],
            [-6.858167, 107.625683],
            [-6.854250, 107.625380],
            [-6.854009, 107.624105],
            [-6.850815, 107.625744],
            [-6.849911, 107.625197],
            [-6.851538, 107.623862],
            [-6.852985, 107.623984],
            [-6.854371, 107.623013],
            [-6.858408, 107.622466],
            [-6.859794, 107.622952],
            [-6.861180, 107.622709],
            [-6.861722, 107.621677],
            [-6.862445, 107.621617],
            [-6.862987, 107.620403],
            [-6.862566, 107.619735],
            [-6.862023, 107.620464],
            [-6.861481, 107.619917],
            [-6.862445, 107.618886],
            [-6.861300, 107.616822],
            [-6.862144, 107.616337],
            [-6.862566, 107.617368],
            [-6.865579, 107.615608],
            [-6.866653, 107.615753],
            [-6.868302, 107.613299],
            [-6.868946, 107.614093],
            [-6.871598, 107.612433],
            [-6.870595, 107.611206],
            [-6.868158, 107.611350],
            [-6.867370, 107.612793],
            [-6.864289, 107.610700],
            [-6.862354, 107.608607],
            [-6.857051, 107.610051],
            [-6.855618, 107.612505],
            [-6.854830, 107.612288],
            [-6.854901, 107.609979],
            [-6.856406, 107.609906],
            [-6.858914, 107.606731],
            [-6.858126, 107.605793],
            [-6.859344, 107.604566],
            [-6.856263, 107.603772],
            [-6.855761, 107.601318],
            [-6.859201, 107.600957],
            [-6.859702, 107.599369],
            [-6.858413, 107.599297],
            [-6.858484, 107.598214],
            [-6.849384, 107.600885],
            [-6.849025, 107.599080],
            [-6.847090, 107.599369],
            [-6.847091, 107.602400],
            [-6.844582, 107.601029],
            [-6.843508, 107.601823],
            [-6.842433, 107.600957],
            [-6.841931, 107.598792],
            [-6.843507, 107.598647],
            [-6.842501, 107.596915],
            [-6.841573, 107.597493],
            [-6.839423, 107.597348]
          ],
          center: [-6.914744, 107.609810]
      },
      layers: [
        {
          id: 0,
          name: "SWK Kota BAndung",
          active: false,
          features: [
            {
              id: 1,
              name: "Bojonagara",
              type: "polygon",
              coords: [
                [-6.839250, 107.596872],
                [-6.843597, 107.596528],
                [-6.843512, 107.596099],
                [-6.846154, 107.594554],
                [-6.845642, 107.593953],
                [-6.846835, 107.593266],
                [-6.846409, 107.592751],
                [-6.849647, 107.589577],
                [-6.853482, 107.590349],
                [-6.853482, 107.588632],
                [-6.857402, 107.589233],
                [-6.859618, 107.586229],
                [-6.859533, 107.583826],
                [-6.859788, 107.583998],
                [-6.867372, 107.576959],
                [-6.867543, 107.575586],
                [-6.868821, 107.577045],
                [-6.875980, 107.573783],
                [-6.877172, 107.573956],
                [-6.878280, 107.572582],
                [-6.883989, 107.571638],
                [-6.886290, 107.572840],
                [-6.890721, 107.576359],
                [-6.887994, 107.562797],
                [-6.888164, 107.558334],
                [-6.889016, 107.556274],
                [-6.910319, 107.569063],
                [-6.915993, 107.572299],
                [-6.917175, 107.574356], // bunderan elang-soetta-sudirman
                [-6.920825, 107.604091], // perempatan sudirman-otista
                [-6.912750, 107.604661],
                [-6.912624, 107.603939], // pertigaan cicendo-kebon kawung
                [-6.909113, 107.604444],
                [-6.900284, 107.604195], // lampu merah cihampelas
                [-6.900284, 107.602268], // lampu merah cipaganti
                [-6.894218, 107.602613],
                [-6.887606, 107.602204],
                [-6.883274, 107.601209],
                [-6.881653, 107.599525],
                [-6.877295, 107.597407],
                [-6.876104, 107.597560],
                [-6.875851, 107.596922],
                [-6.871848, 107.593988],
                [-6.870354, 107.593426], // pertigaan gerlong
                [-6.863640, 107.594447], // depan upi
                [-6.863007, 107.595812],
                [-6.862355, 107.596283],
                [-6.860896, 107.594663],
                [-6.858670, 107.594939], // depan ledeng
                [-6.848942, 107.597185],
                [-6.849165, 107.598036],
                [-6.849084, 107.598523],
                [-6.847965, 107.598369],
                [-6.847216, 107.599203],
                [-6.846432, 107.599355],
                [-6.845687, 107.600022],
                [-6.845197, 107.599279],
                [-6.844338, 107.600220],
                [-6.843879, 107.600121],
                [-6.842606, 107.596920],
                [-6.842501, 107.596915],
                [-6.841573, 107.597493],
                [-6.839423, 107.597348]
              ],
              center: [-6.889539, 107.592143],
              isActive: true
            }
          ]
        }
      ],
    }
  },
  // computed: {
  //   onClickListener() {
  //     return this.isFilled ? this.onPolyClickIn : this.onPolyClickOut
  //   }
  // },
  methods: {
    initMap() {
      this.map = L.map('map').setView([-6.911056, 107.636914], this.mapMinZoom);
      this.map.dragging.disable()
      this.tileLayer = L.tileLayer(
        'https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png',
        {
          maxZoom: this.mapMaxZoom,
          minZoom: this.mapMinZoom,
          bounds: [
                [-6.843263, 107.597039],
                [-6.889269, 107.556148],
                [-6.963528, 107.626210],
                [-6.909502, 107.736855]
              ],
          attributionControl: false
        }
      );
      this.tileLayer.addTo(this.map);
    },
    initBackground(){
      const background = this.backgroundLayer
      const outerBounds = new L.LatLngBounds([-90, -360], [90, 360])
      var outerBoundsLatLngs = [
        outerBounds.getSouthWest(),
        outerBounds.getNorthWest(),
        outerBounds.getNorthEast(),
        outerBounds.getSouthEast()
      ]
      background.leafletObject = L.polygon([outerBoundsLatLngs, background.coords]).setStyle({
        fillColor: "#FFFFFF",
        fillOpacity: 1
      })
      background.leafletObject.addTo(this.map)
    },
    initLayers() {
      this.layers.forEach((layer) => {
        const markerFeatures = layer.features.filter(feature => feature.type === 'marker');
        const polygonFeatures = layer.features.filter(feature => feature.type === 'polygon');
        markerFeatures.forEach((feature) => {
          feature.leafletObject = L.marker(feature.coords)
            .bindPopup(feature.name);
        });
        polygonFeatures.forEach((feature) => {
          feature.leafletObject = L.polygon(feature.coords, {
            'label' : feature.name,
            'center' : feature.center
          })
          feature.leafletObject.bindPopup(feature.name + "\n13")
          feature.leafletObject.on('mouseover', this.onPolyHover)
          feature.leafletObject.on('mouseout', this.onPolyOut)
          feature.leafletObject.on('click', this.onPolyClickIn)
        });
        layer.features.forEach((feature) => {
          if (layer.active) {
            feature.leafletObject.addTo(this.map)
          }
        })
      })
    },
    onPolyClickIn(event){
      event.target.setStyle({
        fillOpacity: 0,
      })
      this.isFilled = false
      this.map.fitBounds(event.target.getBounds())
      event.target.off('click', this.onPolyClickIn)
      event.target.on('click', this.onPolyClickOut)
      this.$root.$emit('click', "agung")
    },
    onPolyClickOut(event){
      event.target.setStyle({
        fillOpacity: 0.1,
      })
      this.isFilled = true
      this.map.setView(event.target.options.center, this.mapMinZoom)
      event.target.off('click', this.onPolyClickOut)
      event.target.on('click', this.onPolyClickIn)
    },
    onPolyHover(event){
      event.target.openPopup();
    },
    onPolyOut(event){
      event.target.closePopup();
    }
  },
  mounted() {
    this.initMap();
    this.initBackground();
    this.initLayers();
  },
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped>
.map {
  height: 600px;
}
</style>
